workflows:
  ios_release:
    name: iOS Release
    max_build_duration: 60
    instance_type: mac_mini_m1
    working_directory: .
    integrations:
      app_store_connect: Codemagic API Key   # <-- must match the name you used in Codemagic
    environment:
      flutter: stable
      xcode: latest
    scripts:
  - flutter --version
  - flutter clean
  - flutter pub get

  # Fetch signing files (uses your "Codemagic API Key" integration)
  - keychain initialize
  - app-store-connect fetch-signing-files
      bundle_id: com.zeusconcrete.pileestimator
      type: IOS_APP_STORE
      create: true
  - keychain add-certificates

  # Build the iOS app without signing (Flutter), then sign & create IPA with Xcode
  - flutter build ios --release --no-codesign
  - xcode-project use-profiles
  - xcode-project build-ipa

    artifacts:
      - build/ios/ipa/*.ipa
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
